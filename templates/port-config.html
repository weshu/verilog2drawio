<div id="port-config" class="panel d-none">
    <h4>Port Configuration</h4>
    <div class="form-group">
        <label for="port-select">Select Ports:</label>
        <select id="port-select" class="form-control selectpicker" multiple data-live-search="true">
            <!-- Ports will be dynamically populated here -->
        </select>
    </div>
    <table id="port-table" class="table table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th>Group Name</th>
                <th>Port Name</th>
                <th>Port Type</th>
            </tr>
        </thead>
        <tbody id="port-list">
            <!-- Ports will be dynamically populated here -->
        </tbody>
    </table>
    <button class="btn btn-primary" onclick="groupPorts()">Group Selected Ports</button>
    <button class="btn btn-danger" onclick="ungroupPorts()">Ungroup Selected Ports</button>
    <button class="btn btn-success" onclick="saveGroups()">Save and Continue</button>
</div>

<script>
    let portGroups = [];
    let ungroupedPorts = [];

    function loadPorts() {
        const filename = new URLSearchParams(window.location.search).get('filename');
        if (!filename) {
            alert('No filename found in URL.');
            return;
        }
        fetch(`/get_ports?filename=${filename}`)
            .then(response => response.json())
            .then(data => {
                if (data.ports) {
                    ungroupedPorts = data.ports;
                    renderPorts();
                } else {
                    alert('No ports found in the response.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to fetch ports.');
            });
    }

    function renderPorts() {
        const portList = document.getElementById('port-list');
        const portSelect = document.getElementById('port-select');
        portList.innerHTML = '';
        portSelect.innerHTML = '';
        
        // Render ungrouped ports
        ungroupedPorts.forEach(port => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" value=""></td>
                <td>${port['name']}</td>
                <td>${port['type'] || 'N/A'}</td>
            `;
            portList.appendChild(row);

            const option = document.createElement('option');
            option.value = port['name'];
            option.text = port['name'];
            portSelect.appendChild(option);
        });

        // Render grouped ports
        portGroups.forEach((group, index) => {
            group.ports.forEach(port => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" value="${group.name}" onchange="editGroupName(${index}, this.value)"></td>
                    <td>${port['name']}</td>
                    <td>${port['type'] || 'N/A'}</td>
                `;
                portList.appendChild(row);
            });
        });

        // Initialize the selectpicker
        $('.selectpicker').selectpicker('refresh');
    }

    function groupPorts() {
        const selectedPorts = Array.from(document.querySelectorAll('#port-select option:checked')).map(option => option.value);
        if (selectedPorts.length === 0) {
            alert('Please select at least one port to group.');
            return;
        }
        const groupName = `grp_id_${portGroups.length + 1}`;
        const ports = selectedPorts.map(portName => ungroupedPorts.find(port => port.name === portName));
        portGroups.push({ name: groupName, ports });
        ungroupedPorts = ungroupedPorts.filter(port => !selectedPorts.includes(port.name));
        renderPorts();
    }

    function ungroupPorts() {
        const selectedPorts = Array.from(document.querySelectorAll('#port-select option:checked')).map(option => option.value);
        if (selectedPorts.length === 0) {
            alert('Please select at least one port to ungroup.');
            return;
        }
        portGroups = portGroups.map(group => {
            group.ports = group.ports.filter(port => !selectedPorts.includes(port.name));
            return group;
        }).filter(group => group.ports.length > 0);
        selectedPorts.forEach(portName => {
            const port = portGroups.flatMap(group => group.ports).find(p => p.name === portName);
            if (port) {
                ungroupedPorts.push(port);
            }
        });
        renderPorts();
    }

    function editGroupName(index, newName) {
        portGroups[index].name = newName;
        renderPorts();
    }

    function saveGroups() {
        fetch('/save_groups', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ groups: portGroups })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPanel('submodule-config');
            } else {
                alert('Failed to save groups.');
            }
        });
    }
</script>